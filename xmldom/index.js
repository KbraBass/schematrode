const fs = require('fs');
const xpath = require('xpath');
const { DOMParser } = require('xmldom');

const invoice = "<Invoice xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\" xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\" xmlns:cec=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2\">\n  <cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:fdc:peppol.eu:2017:poacc:billing:3.0</cbc:CustomizationID>\n  <cbc:ProfileID>urn:fdc:peppol.eu:2017:poacc:billing:01:1.0</cbc:ProfileID>\n  <cbc:ID>2558454</cbc:ID>\n  <cbc:IssueDate>2023-09-22</cbc:IssueDate>\n  <cbc:DueDate>2023-10-22</cbc:DueDate>\n  <cbc:InvoiceTypeCode listID=\"UNCL1001\">380</cbc:InvoiceTypeCode>\n  <cbc:Note>Kundnummer: 10010055</cbc:Note>\n  <cbc:TaxPointDate>2023-09-21</cbc:TaxPointDate>\n  <cbc:DocumentCurrencyCode listID=\"ISO4217\">SEK</cbc:DocumentCurrencyCode>\n  <cbc:AccountingCost>A Hus Juni-Aug 2023</cbc:AccountingCost>\n  <cbc:BuyerReference>Magnus Carlsson Alnarp</cbc:BuyerReference>\n  <cac:AccountingSupplierParty>\n    <cac:Party>\n      <cbc:EndpointID schemeID=\"0007\">2021002817</cbc:EndpointID>\n      <cac:PartyIdentification>\n        <cbc:ID schemeID=\"0007\">2021002817</cbc:ID>\n              </cac:PartyIdentification>\n      <cac:PartyName>\n        <cbc:Name>SLU</cbc:Name>\n              </cac:PartyName>\n      <cac:PostalAddress>\n        <cbc:StreetName>BOX 7086</cbc:StreetName>\n        <cbc:CityName>UPPSALA</cbc:CityName>\n        <cbc:PostalZone>750 07</cbc:PostalZone>\n        <cac:Country>\n          <cbc:IdentificationCode listID=\"ISO3166-1:Alpha2\">SE</cbc:IdentificationCode>\n                  </cac:Country>\n              </cac:PostalAddress>\n      <cac:PartyTaxScheme>\n        <cbc:CompanyID>SE202100281701</cbc:CompanyID>\n        <cac:TaxScheme>\n          <cbc:ID>VAT</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:PartyTaxScheme>\n      <cac:PartyTaxScheme>\n        <cbc:CompanyID>Godkänd för F-skatt</cbc:CompanyID>\n        <cac:TaxScheme>\n          <cbc:ID>TAX</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:PartyTaxScheme>\n      <cac:PartyLegalEntity>\n        <cbc:RegistrationName>SLU</cbc:RegistrationName>\n        <cbc:CompanyID>2021002817</cbc:CompanyID>\n        <cbc:CompanyLegalForm>Uppsala</cbc:CompanyLegalForm>\n              </cac:PartyLegalEntity>\n      <cac:Contact>\n        <cbc:Telephone>018-671000</cbc:Telephone>\n        <cbc:ElectronicMail>Sonja.Trulsson@slu.se</cbc:ElectronicMail>\n              </cac:Contact>\n          </cac:Party>\n      </cac:AccountingSupplierParty>\n  <cac:AccountingCustomerParty>\n    <cac:Party>\n      <cbc:EndpointID schemeID=\"0007\">5564599156</cbc:EndpointID>\n      <cac:PartyIdentification>\n        <cbc:ID schemeID=\"0007\">5564599156</cbc:ID>\n              </cac:PartyIdentification>\n      <cac:PartyName>\n        <cbc:Name>AKADEMISKA HUS  AB</cbc:Name>\n              </cac:PartyName>\n      <cac:PostalAddress>\n        <cbc:StreetName>FE 35</cbc:StreetName>\n        <cbc:CityName>FRÖSÖN</cbc:CityName>\n        <cbc:PostalZone>838 73</cbc:PostalZone>\n        <cac:Country>\n          <cbc:IdentificationCode listID=\"ISO3166-1:Alpha2\">SE</cbc:IdentificationCode>\n                  </cac:Country>\n              </cac:PostalAddress>\n      <cac:PartyLegalEntity>\n        <cbc:RegistrationName>AKADEMISKA HUS  AB</cbc:RegistrationName>\n        <cbc:CompanyID>5564599156</cbc:CompanyID>\n              </cac:PartyLegalEntity>\n      <cac:Contact>\n        <cbc:Name>AKADEMISKA HUS  AB</cbc:Name>\n              </cac:Contact>\n          </cac:Party>\n      </cac:AccountingCustomerParty>\n  <cac:Delivery>\n    <cbc:ActualDeliveryDate>2023-09-21</cbc:ActualDeliveryDate>\n    <cac:DeliveryLocation>\n      <cac:Address>\n        <cbc:StreetName>BOX 50</cbc:StreetName>\n        <cbc:CityName>ALNARP</cbc:CityName>\n        <cbc:PostalZone>230 53</cbc:PostalZone>\n        <cac:Country>\n          <cbc:IdentificationCode listID=\"ISO3166-1:Alpha2\">SE</cbc:IdentificationCode>\n                  </cac:Country>\n              </cac:Address>\n          </cac:DeliveryLocation>\n      </cac:Delivery>\n  <cac:PaymentMeans>\n    <cbc:PaymentMeansCode>30</cbc:PaymentMeansCode>\n    <cbc:PaymentID>255845497</cbc:PaymentID>\n    <cac:PayeeFinancialAccount>\n      <cbc:ID>50524891</cbc:ID>\n      <cac:FinancialInstitutionBranch>\n        <cbc:ID>SE:BANKGIRO</cbc:ID>\n              </cac:FinancialInstitutionBranch>\n          </cac:PayeeFinancialAccount>\n      </cac:PaymentMeans>\n  <cac:PaymentTerms>\n    <cbc:Note>30 dagar netto</cbc:Note>\n      </cac:PaymentTerms>\n  <cac:TaxTotal>\n    <cbc:TaxAmount currencyID=\"SEK\">538.63</cbc:TaxAmount>\n    <cac:TaxSubtotal>\n      <cbc:TaxableAmount currencyID=\"SEK\">2154.50</cbc:TaxableAmount>\n      <cbc:TaxAmount currencyID=\"SEK\">538.63</cbc:TaxAmount>\n      <cac:TaxCategory>\n        <cbc:ID schemeID=\"UNCL5305\">S</cbc:ID>\n        <cbc:Percent>25</cbc:Percent>\n        <cac:TaxScheme>\n          <cbc:ID>VAT</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:TaxCategory>\n          </cac:TaxSubtotal>\n      </cac:TaxTotal>\n  <cac:LegalMonetaryTotal>\n    <cbc:LineExtensionAmount currencyID=\"SEK\">2154.50</cbc:LineExtensionAmount>\n    <cbc:TaxExclusiveAmount currencyID=\"SEK\">2154.50</cbc:TaxExclusiveAmount>\n    <cbc:TaxInclusiveAmount currencyID=\"SEK\">2693.13</cbc:TaxInclusiveAmount>\n    <cbc:AllowanceTotalAmount currencyID=\"SEK\">0.00</cbc:AllowanceTotalAmount>\n    <cbc:ChargeTotalAmount currencyID=\"SEK\">0.00</cbc:ChargeTotalAmount>\n    <cbc:PayableRoundingAmount currencyID=\"SEK\">-0.13</cbc:PayableRoundingAmount>\n    <cbc:PayableAmount currencyID=\"SEK\">2693.00</cbc:PayableAmount>\n      </cac:LegalMonetaryTotal>\n  <cac:InvoiceLine>\n    <cbc:ID>1</cbc:ID>\n    <cbc:Note>230616\nOrdernummer: 610202053</cbc:Note>\n    <cbc:InvoicedQuantity unitCode=\"HUR\" unitCodeListID=\"UNECERec20\">1</cbc:InvoicedQuantity>\n    <cbc:LineExtensionAmount currencyID=\"SEK\">423.00</cbc:LineExtensionAmount>\n    <cac:Item>\n      <cbc:Name>Sanerat Miljöstation nr 7</cbc:Name>\n      <cac:SellersItemIdentification>\n        <cbc:ID>A3336</cbc:ID>\n              </cac:SellersItemIdentification>\n      <cac:ClassifiedTaxCategory>\n        <cbc:ID schemeID=\"UNCL5305\">S</cbc:ID>\n        <cbc:Percent>25</cbc:Percent>\n        <cac:TaxScheme>\n          <cbc:ID>VAT</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:ClassifiedTaxCategory>\n          </cac:Item>\n    <cac:Price>\n      <cbc:PriceAmount currencyID=\"SEK\">423</cbc:PriceAmount>\n          </cac:Price>\n      </cac:InvoiceLine>\n  <cac:InvoiceLine>\n    <cbc:ID>2</cbc:ID>\n    <cbc:Note>Ordernummer: 610202053</cbc:Note>\n    <cbc:InvoicedQuantity unitCode=\"HUR\" unitCodeListID=\"UNECERec20\">1.5</cbc:InvoicedQuantity>\n    <cbc:LineExtensionAmount currencyID=\"SEK\">634.50</cbc:LineExtensionAmount>\n    <cac:Item>\n      <cbc:Name>Röjt innergård H hus för plattsättning</cbc:Name>\n      <cac:SellersItemIdentification>\n        <cbc:ID>A3336</cbc:ID>\n              </cac:SellersItemIdentification>\n      <cac:ClassifiedTaxCategory>\n        <cbc:ID schemeID=\"UNCL5305\">S</cbc:ID>\n        <cbc:Percent>25</cbc:Percent>\n        <cac:TaxScheme>\n          <cbc:ID>VAT</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:ClassifiedTaxCategory>\n          </cac:Item>\n    <cac:Price>\n      <cbc:PriceAmount currencyID=\"SEK\">423</cbc:PriceAmount>\n          </cac:Price>\n      </cac:InvoiceLine>\n  <cac:InvoiceLine>\n    <cbc:ID>3</cbc:ID>\n    <cbc:Note>Samtliga jobb beställt av Magnus Carlsson\nOrdernummer: 610202053</cbc:Note>\n    <cbc:InvoicedQuantity unitCode=\"EA\" unitCodeListID=\"UNECERec20\">1</cbc:InvoicedQuantity>\n    <cbc:LineExtensionAmount currencyID=\"SEK\">1097.00</cbc:LineExtensionAmount>\n    <cac:Item>\n      <cbc:Name>Gräsfrö , fjärrvärmegräving</cbc:Name>\n      <cac:SellersItemIdentification>\n        <cbc:ID>A3336</cbc:ID>\n              </cac:SellersItemIdentification>\n      <cac:ClassifiedTaxCategory>\n        <cbc:ID schemeID=\"UNCL5305\">S</cbc:ID>\n        <cbc:Percent>25</cbc:Percent>\n        <cac:TaxScheme>\n          <cbc:ID>VAT</cbc:ID>\n                  </cac:TaxScheme>\n              </cac:ClassifiedTaxCategory>\n          </cac:Item>\n    <cac:Price>\n      <cbc:PriceAmount currencyID=\"SEK\">1097</cbc:PriceAmount>\n          </cac:Price>\n      </cac:InvoiceLine>\n  </Invoice>\n";


(async () => {
  console.time('ReadFile');
  const xmlData = await fs.readFileSync('./Large_Invoice_sample2.xml', 'utf-8');
  console.timeEnd('ReadFile');

  // Parse XML to DOM
  console.time('DOMParser');
  const doc = new DOMParser().parseFromString(xmlData, 'text/xml');
  console.timeEnd('DOMParser');

  // Define namespaces for XPath
  console.time('useNamespaces');
  const select = xpath.useNamespaces({
    'cbc': 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2',
    'cac': 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2'
  });
  console.timeEnd('useNamespaces');

  // Extract values using XPath
  console.time('XPathSelect');
  const invoiceNumber = select('//cbc:ID', doc)[0]?.textContent;
  const issueDate = select('//cbc:IssueDate', doc)[0]?.textContent;
  const customerName = select('//cac:AccountingCustomerParty/cac:Party/cac:PartyName/cbc:Name', doc)[0]?.textContent;
  console.timeEnd('XPathSelect');

  // Print extracted values
  console.log('Invoice Number:', invoiceNumber);
  console.log('Issue Date:', issueDate);
  console.log('Customer Name:', customerName);

})();
